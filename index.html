<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®å®èˆ’é€‚åº¦è®¡ç®—å™¨ï¼ˆä½“æ„Ÿæ¸©åº¦ç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 1rem; background: #f9fafb; }
    h2 { text-align: center; }
    .input-area, .result { margin: 1rem 0; padding: 1rem; background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input { width: 100%; padding: 0.6rem; margin: 0.4rem 0; font-size: 1rem; }
    button { width: 100%; padding: 0.8rem; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; }
    button:hover { background: #45a049; }
    .results { display: flex; justify-content: space-between; flex-wrap: wrap; }
    .card { flex: 1; min-width: 40%; margin: 0.5rem; padding: 0.8rem; border-radius: 12px; background: #f0fdf4; text-align: center; }
    .emoji { font-size: 2rem; }
    .upload { margin-top: 1rem; }
  </style>
</head>
<body>
<h2>å®å®èˆ’é€‚åº¦è®¡ç®—å™¨ï¼ˆä½“æ„Ÿæ¸©åº¦ç‰ˆï¼‰ ğŸ˜Š</h2>

<div class="input-area">
  <label>æ¸©åº¦ (â„ƒ)</label>
  <input id="temp" type="number" inputmode="decimal" step="0.1" placeholder="è¾“å…¥æ¸©åº¦">
  <label>ç›¸å¯¹æ¹¿åº¦ (%)</label>
  <input id="rh" type="number" inputmode="decimal" step="0.1" placeholder="è¾“å…¥ç›¸å¯¹æ¹¿åº¦">
  <label>ç»å¯¹æ¹¿åº¦ (g/mÂ³)</label>
  <input id="ah" type="number" inputmode="decimal" step="0.1" placeholder="è¾“å…¥ç»å¯¹æ¹¿åº¦">
  <label>éœ²ç‚¹æ¸©åº¦ (â„ƒ)</label>
  <input id="dew" type="number" inputmode="decimal" step="0.1" placeholder="è¾“å…¥éœ²ç‚¹æ¸©åº¦">
  <label>é¥±å’Œæ°´æ±½å‹å·® (VPD kPa)</label>
  <input id="vpd" type="number" inputmode="decimal" step="0.01" placeholder="è¾“å…¥VPD">

  <button onclick="calculate()">è®¡ç®—èˆ’é€‚åº¦</button>

  <div class="upload">
    <p>æˆ–ä¸Šä¼ æˆªå›¾è‡ªåŠ¨è¯†åˆ«ï¼š</p>
    <input type="file" accept="image/*" onchange="handleImage(this.files[0])">
    <p id="ocr-loading" style="color:#999; display:none;">æ­£åœ¨è¯†åˆ«å›¾ç‰‡â€¦</p>
  </div>
</div>

<div class="result" id="result"></div>

<script>
function calculate() {
  const temp = parseFloat(document.getElementById("temp").value) || 0;
  const rh = parseFloat(document.getElementById("rh").value) || 0;
  const ah = parseFloat(document.getElementById("ah").value) || 0;
  const dew = parseFloat(document.getElementById("dew").value) || 0;
  const vpd = parseFloat(document.getElementById("vpd").value) || 0;

  // è®¡ç®—è¿‘ä¼¼ä½“æ„Ÿæ¸©åº¦ (ç®€å•ç‰ˆ)
  function apparentTemp(t, r, v) {
    // ç®€åŒ–å…¬å¼ï¼šä½“æ„Ÿæ¸©åº¦ = æ¸©åº¦ + 0.33*é¥±å’Œæ°´æ±½å‹å·®(kPa)*10 - 0.7*(é£é€Ÿå½±å“å¿½ç•¥)
    // è¿™é‡Œç”¨ VPD ä½œä¸ºè’¸å‘å½±å“å‚è€ƒ
    let at = t + 0.33*v*10;
    return at;
  }

  const atemp = apparentTemp(temp, rh, vpd);

  function comfort(t, r, a, d, v, at) {
    let msgs = [];
    if (t >= 22 && t <= 26) msgs.push("æ¸©åº¦èˆ’é€‚");
    else if (t < 20) msgs.push("åå†·");
    else if (t > 28) msgs.push("åçƒ­");

    if (r >= 40 && r <= 65) msgs.push("æ¹¿åº¦èˆ’é€‚");
    else if (r < 35) msgs.push("ç©ºæ°”åå¹²");
    else if (r > 70) msgs.push("ç©ºæ°”åæ¹¿");

    if (v >= 0.5 && v <= 1.5) msgs.push("è’¸å‘é€‚ä¸­");
    else if (v < 0.5) msgs.push("ç©ºæ°”æ¹¿æ¶¦");
    else msgs.push("ç©ºæ°”åå¹²");

    if(at < 20) msgs.push("ä½“æ„Ÿåå†·");
    else if(at > 27) msgs.push("ä½“æ„Ÿåçƒ­");
    else msgs.push("ä½“æ„Ÿèˆ’é€‚");

    return msgs.join("ï¼Œ");
  }

  function sleepAdvice(at) {
    if (at < 20) return "é•¿è¢–+åšç¡è¢‹";
    if (at < 24) return "é•¿è¢–è–„ç¡è¢‹";
    if (at < 27) return "çŸ­è¢–ç¡è¢‹";
    return "è½»è–„çŸ­è¢–";
  }

  document.getElementById("result").innerHTML = `
    <div class="results">
      <div class="card">
        <div class="emoji">ğŸŒ™</div>
        <p>é™éŸ³æ¨¡å¼</p>
        <p>ä½“æ„Ÿæ¸©åº¦: ${atemp.toFixed(1)}â„ƒ</p>
        <p>${comfort(temp, rh, ah, dew, vpd, atemp)}</p>
      </div>
      <div class="card">
        <div class="emoji">ğŸ’¨</div>
        <p>è‡ªåŠ¨æ¨¡å¼</p>
        <p>ä½“æ„Ÿæ¸©åº¦: ${atemp.toFixed(1)}â„ƒ</p>
        <p>${comfort(temp, rh, ah, dew, vpd, atemp)}</p>
      </div>
    </div>
    <div class="card">
      <div class="emoji">ğŸ‘•</div>
      <p>ç¡è§‰å»ºè®®ï¼š${sleepAdvice(atemp)}</p>
    </div>
  `;
}

// OCRå…³é”®å­—è¯†åˆ«
async function handleImage(file) {
  const loading = document.getElementById("ocr-loading");
  loading.style.display = "block";
  try {
    const { data: { text } } = await Tesseract.recognize(file, 'chi_sim+eng');
    loading.style.display = "none";
    console.log("OCRåŸå§‹ç»“æœ:", text);

    const cleanText = text.replace(/[â„ƒ%]/g,"").replace(/\s+/g," ");

    function extractValue(keys) {
      for (let k of keys) {
        const regex = new RegExp(k + "\\s*[:ï¼š]?\\s*([0-9]+\\.?[0-9]*)");
        const match = cleanText.match(regex);
        if (match) return parseFloat(match[1]);
      }
      return null;
    }

    const tempVal = extractValue(["æ¸©åº¦","æ°”æ¸©"]);
    const rhVal   = extractValue(["ç›¸å¯¹æ¹¿åº¦","æ¹¿åº¦"]);
    const ahVal   = extractValue(["ç»å¯¹æ¹¿åº¦"]);
    const dewVal  = extractValue(["éœ²ç‚¹","éœ²ç‚¹æ¸©åº¦"]);
    const vpdVal  = extractValue(["VPD","é¥±å’Œæ°´æ±½å‹å·®"]);

    if(tempVal !== null) document.getElementById("temp").value = tempVal.toFixed(1);
    if(rhVal   !== null) document.getElementById("rh").value   = rhVal.toFixed(1);
    if(ahVal   !== null) document.getElementById("ah").value   = ahVal.toFixed(1);
    if(dewVal  !== null) document.getElementById("dew").value  = dewVal.toFixed(1);
    if(vpdVal  !== null) document.getElementById("vpd").value  = vpdVal.toFixed(2);

    // é¡ºåºè¡¥å……
    const nums = cleanText.match(/[0-9]+\.?[0-9]*/g) || [];
    let idx = 0;
    if(tempVal===null && nums[idx]!==undefined) document.getElementById("temp").value = parseFloat(nums[idx++]).toFixed(1);
    if(rhVal===null   && nums[idx]!==undefined) document.getElementById("rh").value   = parseFloat(nums[idx++]).toFixed(1);
    if(ahVal===null   && nums[idx]!==undefined) document.getElementById("ah").value   = parseFloat(nums[idx++]).toFixed(1);
    if(dewVal===null  && nums[idx]!==undefined) document.getElementById("dew").value  = parseFloat(nums[idx++]).toFixed(1);
    if(vpdVal===null  && nums[idx]!==undefined) document.getElementById("vpd").value  = parseFloat(nums[idx++]).toFixed(2);

    calculate();
  } catch (err) {
    loading.style.display = "none";
    alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•");
    console.error(err);
  }
}
</script>
</body>
</html>
