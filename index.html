<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®å®èˆ’é€‚åº¦è®¡ç®—å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 1rem; background: #f9fafb; }
    h2 { text-align: center; }
    .input-area, .result { 
      margin: 1rem 0; padding: 1rem; 
      background: white; border-radius: 12px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    }
    input { width: 100%; padding: 0.6rem; margin: 0.4rem 0; font-size: 1rem; }
    button { 
      width: 100%; padding: 0.8rem; 
      background: #4CAF50; color: white; border: none; 
      border-radius: 10px; font-size: 1rem; cursor: pointer; 
    }
    button:hover { background: #45a049; }
    .results { display: flex; justify-content: space-between; }
    .card { flex: 1; margin: 0.5rem; padding: 0.8rem; border-radius: 12px; background: #f0fdf4; text-align: center; }
    .emoji { font-size: 2rem; }
    .upload { margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>å®å®èˆ’é€‚åº¦è®¡ç®—å™¨ ğŸ˜Š</h2>

  <div class="input-area">
    <label>æ¸©åº¦</label>
    <input id="temp" type="number" inputmode="decimal" placeholder="è¾“å…¥æ¸©åº¦">
    <label>ç›¸å¯¹æ¹¿åº¦</label>
    <input id="rh" type="number" inputmode="decimal" placeholder="è¾“å…¥ç›¸å¯¹æ¹¿åº¦">
    <label>ç»å¯¹æ¹¿åº¦</label>
    <input id="ah" type="number" inputmode="decimal" placeholder="è¾“å…¥ç»å¯¹æ¹¿åº¦">
    <label>éœ²ç‚¹æ¸©åº¦</label>
    <input id="dew" type="number" inputmode="decimal" placeholder="è¾“å…¥éœ²ç‚¹æ¸©åº¦">
    <label>é¥±å’Œæ°´æ±½å‹å·® (VPD)</label>
    <input id="vpd" type="number" inputmode="decimal" placeholder="è¾“å…¥VPD">
    <button onclick="calculate()">è®¡ç®—èˆ’é€‚åº¦</button>

    <div class="upload">
      <p>æˆ–ä¸Šä¼ æˆªå›¾è‡ªåŠ¨è¯†åˆ«ï¼š</p>
      <input type="file" accept="image/*" onchange="handleImage(this.files[0])">
    </div>
  </div>

  <div class="result" id="result"></div>

  <script>
    function calculate() {
      const temp = parseFloat(document.getElementById("temp").value) || 0;
      const rh = parseFloat(document.getElementById("rh").value) || 0;
      const ah = parseFloat(document.getElementById("ah").value) || 0;
      const dew = parseFloat(document.getElementById("dew").value) || 0;
      const vpd = parseFloat(document.getElementById("vpd").value) || 0;

      const results = {
        quiet: temp - (0.2 * (100 - rh) / 5),
        auto: temp - (0.5 * (100 - rh) / 5)
      };

      const comfort = (t, r, v) => {
        if (t >= 22 && t <= 26 && r >= 40 && r <= 65 && v >= 0.5 && v <= 1.5) {
          return "ğŸ˜Š èˆ’é€‚ï¼Œå®å®å®‰å¿ƒ";
        } else if (t < 20 || t > 28) {
          return "ğŸ¥¶ğŸ¥µ æ¸©åº¦ä¸åˆé€‚ï¼Œéœ€è°ƒæ•´ç©ºè°ƒæˆ–è¡£ç‰©";
        } else if (r < 35) {
          return "ğŸ’¨ ç©ºæ°”åå¹²ï¼Œæ³¨æ„åŠ æ¹¿";
        } else if (r > 70) {
          return "ğŸ’¦ æ¹¿åº¦è¿‡é«˜ï¼Œæ³¨æ„é™¤æ¹¿";
        } else {
          return "ğŸ˜ ä¸€èˆ¬ï¼Œå»ºè®®è§‚å¯Ÿå®å®çŠ¶æ€";
        }
      };

      document.getElementById("result").innerHTML = `
        <div class="results">
          <div class="card">
            <div class="emoji">ğŸŒ™</div>
            <p>é™éŸ³æ¨¡å¼</p>
            <p>ä½“æ„Ÿæ¸©åº¦: ${results.quiet.toFixed(1)}</p>
            <p>${comfort(temp, rh, vpd)}</p>
          </div>
          <div class="card">
            <div class="emoji">ğŸ’¨</div>
            <p>è‡ªåŠ¨æ¨¡å¼</p>
            <p>ä½“æ„Ÿæ¸©åº¦: ${results.auto.toFixed(1)}</p>
            <p>${comfort(temp, rh, vpd)}</p>
          </div>
        </div>
        <div class="card">
          <div class="emoji">ğŸ‘•</div>
          <p>ç¡è§‰å»ºè®®ï¼š${sleepAdvice(temp)}</p>
        </div>
      `;
    }

    function sleepAdvice(temp) {
      if (temp < 20) return "é•¿è¢–+ç¡è¢‹";
      if (temp < 24) return "é•¿è¢–è–„ç¡è¢‹";
      if (temp < 27) return "çŸ­è¢–ç¡è¢‹";
      return "è½»è–„çŸ­è¢–";
    }

    // ---- OCR è¯†åˆ«å¹¶æå– ----
    async function handleImage(file) {
      const { data: { text } } = await Tesseract.recognize(file, 'chi_sim+eng', {
        tessedit_char_whitelist: '0123456789.%'
      });

      console.log("OCRç»“æœ:", text);

      function extractValue(keyword) {
        const regex = new RegExp(keyword + '\\s*([0-9]+\\.?[0-9]*)');
        const match = text.match(regex);
        return match ? parseFloat(match[1]) : '';
      }

      document.getElementById("temp").value = extractValue("æ¸©åº¦");
      document.getElementById("rh").value = extractValue("ç›¸å¯¹æ¹¿åº¦");
      document.getElementById("ah").value = extractValue("ç»å¯¹æ¹¿åº¦");
      document.getElementById("dew").value = extractValue("éœ²ç‚¹æ¸©åº¦");
      document.getElementById("vpd").value = extractValue("VPD");

      calculate();
    }
  </script>
</body>
</html>
