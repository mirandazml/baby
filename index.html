<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>体感温度与舒适度计算</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    label { display: block; margin-top: 8px; font-size: 14px; }
    input { width: 100%; padding: 6px; margin-top: 4px; font-size: 16px; box-sizing: border-box; }
    button { margin-top: 12px; padding: 10px; width: 100%; font-size: 16px; }
    #result { margin-top: 20px; padding: 12px; border: 1px solid #ccc; font-size: 16px; }
    /* 手机适配 */
    @media (max-width: 600px) {
      body { margin: 5px; font-size: 16px; }
      input, button { font-size: 18px; }
    }
    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h2>体感温度与舒适度计算2</h2>

  <label>室内温度 (℃): <input type="number" id="temperature"></label>
  <label>相对湿度 (%): <input type="number" id="humidity"></label>
  <label>绝对湿度 (g/m³): <input type="number" id="absHumidity"></label>
  <label>露点温度 (℃): <input type="number" id="dewPoint"></label>
  <label>VPD (kPa): <input type="number" id="vpd"></label>
  <label>风速 (m/s): <input type="number" id="windSpeed" value="0.2"></label>

  <button onclick="calcAT()">计算</button>
  <input type="file" id="imageInput" accept="image/*" onchange="extractText()">

  <div id="result"></div>

  <div style="margin-top:20px; padding:10px; border:1px solid #ccc;">
    <h3>OCR结果预览</h3>
    <p><b>原始识别文本:</b></p>
    <pre id="ocrRaw"></pre>
    <p><b>提取到的数值 (按顺序填充):</b></p>
    <pre id="ocrValues"></pre>
  </div>

  <script>
    function calcAT() {
      const T = parseFloat(document.getElementById("temperature").value);
      const RH = parseFloat(document.getElementById("humidity").value);
      const AH = parseFloat(document.getElementById("absHumidity").value);
      const DP = parseFloat(document.getElementById("dewPoint").value);
      const VPD = parseFloat(document.getElementById("vpd").value);
      const v = parseFloat(document.getElementById("windSpeed").value);

      if ([T,RH,AH,DP,VPD].some(isNaN)) {
        document.getElementById("result").innerText = "请输入完整数据";
        return;
      }

      let AT = T + 0.33 * AH - 0.70 * v - 4.0 + 0.2 * (T - DP) - 0.5 * VPD;

      let comfort = "";
      if (AT >= 20 && AT <= 27 && RH >= 40 && RH <= 60 && VPD >= 0.8 && VPD <= 1.6) {
        comfort = "舒适";
      } else if (AT < 20) comfort = "偏冷";
      else if (AT > 27) comfort = "偏热";
      else if (RH < 40) comfort = "干燥";
      else if (RH > 60) comfort = "潮湿";
      else if (VPD < 0.8) comfort = "湿度过高";
      else if (VPD > 1.6) comfort = "湿度不足";

      document.getElementById("result").innerText =
        `体感温度: ${AT.toFixed(2)}℃\n舒适度: ${comfort}`;
    }

    async function extractText() {
      const file = document.getElementById('imageInput').files[0];
      if (!file) { alert("请先上传图片！"); return; }

      const { createWorker } = Tesseract;
      const worker = await createWorker('chi_sim');
      const { data: { text } } = await worker.recognize(file);

      document.getElementById("ocrRaw").innerText = text;

      // 提取所有数字
      let numbers = text.replace(/,/g,".").match(/[0-9]+(\.[0-9]+)?/g) || [];
      document.getElementById("ocrValues").innerText = numbers.join(", ");

      // 按顺序填充：温度 → 相对湿度 → 绝对湿度 → 露点温度 → VPD
      if (numbers.length >= 5) {
        document.getElementById("temperature").value = numbers[0];
        document.getElementById("humidity").value = numbers[1];
        document.getElementById("absHumidity").value = numbers[2];
        document.getElementById("dewPoint").value = numbers[3];
        document.getElementById("vpd").value = numbers[4];
        calcAT(); // 自动计算
      }
    }
  </script>
</body>
</html>
