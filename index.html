<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>环境参数识别与计算</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: inline-block; width: 120px; }
    input { width: 100px; margin: 5px; }
    .highlight { background: #e6ffe6; }
  </style>
</head>
<body>
  <h2>环境参数识别与计算</h2>
  
  <input type="file" id="imageUpload" accept="image/*"><br><br>
  
  <div>
    <label>温度 (℃):</label>
    <input type="text" id="temp"><br>
    <label>相对湿度 (%):</label>
    <input type="text" id="rh"><br>
    <label>绝对湿度 (g/m³):</label>
    <input type="text" id="ah"><br>
    <label>露点温度 (℃):</label>
    <input type="text" id="dewPoint"><br>
    <label>VPD (kPa):</label>
    <input type="text" id="vpd"><br>
  </div>

  <h3>舒适度指数</h3>
  <p id="result">等待识别或输入...</p>

  <script>
    document.getElementById('imageUpload').addEventListener('change', function (event) {
      if (!event.target.files.length) return;
      const reader = new FileReader();
      reader.onload = function () {
        Tesseract.recognize(
          reader.result,
          'eng+chi_sim',
          { logger: m => console.log(m) }
        ).then(({ data: { text } }) => {
          // 预清理
          let cleanText = text
            .replace(/,/g, ".")
            .replace(/℃|°C|%|g\/m³|kPa/g, "")
            .replace(/\s+/g, " ")
            .trim();
          console.log("清理后的文本:", cleanText);

          const extractValue = (pattern) => {
            const match = cleanText.match(pattern);
            return match ? match[1] : null;
          };

          const patterns = {
            temp: /温度.*?(\d+(\.\d+)?)/,
            rh: /相对湿度.*?(\d+(\.\d+)?)/,
            ah: /绝对湿度.*?(\d+(\.\d+)?)/,
            dewPoint: /露点温度.*?(\d+(\.\d+)?)/,
            vpd: /(VPD|饱和水汽压差).*?(\d+(\.\d+)?)/,
          };

          const values = {
            temp: extractValue(patterns.temp),
            rh: extractValue(patterns.rh),
            ah: extractValue(patterns.ah),
            dewPoint: extractValue(patterns.dewPoint),
            vpd: extractValue(patterns.vpd),
          };

          console.log("提取结果:", values);

          // 填入并高亮输入框
          Object.keys(values).forEach(id => {
            if (values[id] !== null) {
              let input = document.getElementById(id);
              input.value = values[id];
              input.classList.add("highlight");
              setTimeout(() => input.classList.remove("highlight"), 1500);
            }
          });

          calcAT();
        }).catch(err => {
          console.error(err);
          alert("OCR 识别出错");
        });
      };
      reader.readAsDataURL(event.target.files[0]);
    });

    function calcAT() {
      let T = parseFloat(document.getElementById("temp").value);
      let RH = parseFloat(document.getElementById("rh").value);
      let VPD = parseFloat(document.getElementById("vpd").value);

      if (!isNaN(T) && !isNaN(RH)) {
        let comfortIndex = (100 - Math.abs(T - 22) * 2 - Math.abs(RH - 50)) + (VPD ? (5 - Math.abs(VPD - 1.2) * 5) : 0);
        document.getElementById("result").innerText =
          "综合舒适度指数: " + comfortIndex.toFixed(1);
      } else {
        document.getElementById("result").innerText = "请确认温度和湿度输入正确";
      }
    }

    // 输入框手动修改时也更新结果
    document.querySelectorAll("input[type=text]").forEach(input => {
      input.addEventListener("input", calcAT);
    });
  </script>
</body>
</html>
