<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®å®ä½“æ„Ÿæ¸©åº¦</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; margin: 0; padding: 1rem; }
    h2 { font-size: 1.5rem; text-align: center; color: #333; margin-bottom: 1rem; }
    .container { max-width: 480px; margin: 0 auto; background: #fff; padding: 1rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 0.8rem; font-size: 1rem; color: #555; }
    input { padding: 0.5rem; width: 100%; font-size: 0.95rem; margin-top: 0.3rem; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; }
    .results { display: flex; justify-content: space-between; margin-top: 1rem; gap: 4%; }
    .result-box { flex: 1; text-align: center; background: #fafafa; padding: 0.6rem; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .result { font-weight: bold; font-size: 1rem; }
    .comfort { font-weight: bold; font-size: 1rem; }
    .sleep { color: #6a1b9a; font-weight: bold; font-size: 0.95rem; }
    .tips { font-size: 0.85rem; color: #666; margin-top: 0.25rem; line-height: 1.3; }
  </style>
</head>
<body>
  <div class="container">
    <h2>å®å®ä½“æ„Ÿæ¸©åº¦ä¸èˆ’é€‚åº¦ ğŸŒˆ</h2>

    <label>ä¸Šä¼ å›¾ç‰‡: <input type="file" id="upload" accept="image/*"></label>

    <label>æ¸©åº¦: <input type="number" inputmode="decimal" pattern="[0-9]*" id="temp" placeholder="è¯·è¾“å…¥æ¸©åº¦"></label>
    <label>ç›¸å¯¹æ¹¿åº¦: <input type="number" inputmode="decimal" pattern="[0-9]*" id="rh" placeholder="è¯·è¾“å…¥ç›¸å¯¹æ¹¿åº¦"></label>
    <label>ç»å¯¹æ¹¿åº¦: <input type="number" inputmode="decimal" pattern="[0-9]*" id="ah" placeholder="è¯·è¾“å…¥ç»å¯¹æ¹¿åº¦"></label>
    <label>éœ²ç‚¹æ¸©åº¦: <input type="number" inputmode="decimal" pattern="[0-9]*" id="dewPoint" placeholder="è¯·è¾“å…¥éœ²ç‚¹æ¸©åº¦"></label>
    <label>é¥±å’Œæ°´æ±½å‹å·® (VPD): <input type="number" inputmode="decimal" pattern="[0-9]*" id="vpd" placeholder="è¯·è¾“å…¥VPD"></label>

    <div class="results">
      <div class="result-box">
        <div class="result" id="resultSilent"></div>
        <div class="comfort" id="comfortSilent"></div>
        <div class="sleep" id="sleepSilent"></div>
        <div class="tips" id="tipsSilent"></div>
      </div>
      <div class="result-box">
        <div class="result" id="resultAuto"></div>
        <div class="comfort" id="comfortAuto"></div>
        <div class="sleep" id="sleepAuto"></div>
        <div class="tips" id="tipsAuto"></div>
      </div>
    </div>
  </div>

  <script>
    // å›¾ç‰‡ä¸Šä¼ è¯†åˆ«
    document.getElementById('upload').addEventListener('change', function(e){
      if(e.target.files.length === 0) return;
      let file = e.target.files[0];
      let reader = new FileReader();
      reader.onload = function(event){
        Tesseract.recognize(event.target.result, 'eng').then(({ data: { text } }) => {
          let nums = text.match(/\d+(\.\d+)?/g);
          if(nums && nums.length >= 5){
            document.getElementById('temp').value = nums[0];
            document.getElementById('rh').value = nums[1];
            document.getElementById('ah').value = nums[2];
            document.getElementById('dewPoint').value = nums[3];
            document.getElementById('vpd').value = nums[4];
            calcAT();
          } else {
            alert('æœªè¯†åˆ«åˆ°è¶³å¤Ÿçš„æ•°å­—ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”ä¿¡æ¯å®Œæ•´');
          }
        });
      };
      reader.readAsDataURL(file);
    });

    // è¾“å…¥è‡ªåŠ¨è®¡ç®—
    ['temp','rh','ah','dewPoint','vpd'].forEach(id => {
      document.getElementById(id).addEventListener('input', calcAT);
    });

    function calcAT() {
      let T = parseFloat(document.getElementById('temp').value);
      let RH = parseFloat(document.getElementById('rh').value);
      let AH = parseFloat(document.getElementById('ah').value);
      let Td = parseFloat(document.getElementById('dewPoint').value);
      let VPD = parseFloat(document.getElementById('vpd').value);
      if ([T,RH,AH,Td,VPD].some(isNaN)) {
        ['resultSilent','resultAuto','comfortSilent','comfortAuto','sleepSilent','sleepAuto','tipsSilent','tipsAuto'].forEach(id=>document.getElementById(id).innerText='');
        return;
      }

      // ç®€åŒ–ç‰ˆ Steadman ä½“æ„Ÿæ¸©åº¦ (AT)ï¼Œä¸¤ç§é£é€Ÿ
      let e = (RH / 100) * 6.105 * Math.exp((17.27 * T) / (237.7 + T));
      let AT_silent = T + 0.33 * e - 0.70 * 0.2 - 4.00; // é™éŸ³ 0.2 m/s
      let AT_auto   = T + 0.33 * e - 0.70 * 0.5 - 4.00; // è‡ªåŠ¨ 0.5 m/s

      function scoreAndAdvice(AT,RH,AH,Td,VPD){
        // â€”â€” ä¼˜åŒ–åçš„å¤šå› å­æ‰“åˆ† â€”â€”
        // æ¸©åº¦ï¼š25 ä¸ºä¸­å¿ƒï¼ŒÂ±1 ä»¥å†…ä¸æ‰£åˆ†ï¼Œä¹‹åæ¯ 0.5 æ‰£ 1.5 åˆ†
        let temp_dev = Math.max(0, Math.abs(AT - 25) - 1);
        let tempScore = Math.floor(temp_dev / 0.5) * 1.5;

        // ç›¸å¯¹æ¹¿åº¦ï¼š40-60 ç†æƒ³ï¼›35-40/60-65 è½»å¾®ï¼›30-35/65-70 ä¸­ç­‰ï¼›<30 æˆ– >70 ä¸¥é‡
        let rhScore = 0;
        if (RH < 40 || RH > 60) {
          let d = RH < 40 ? 40 - RH : RH - 60;
          if (d <= 5) rhScore = 1; else if (d <= 10) rhScore = 2; else rhScore = 3;
        }

        // ç»å¯¹æ¹¿åº¦ï¼š11-15 ç†æƒ³ï¼›9-11/15-17 è½»å¾®ï¼›7-9/17-19 ä¸­ç­‰ï¼›<7 æˆ– >19 ä¸¥é‡
        let ahScore = 0;
        if (AH < 11 || AH > 15) {
          let d = AH < 11 ? 11 - AH : AH - 15;
          if (d <= 2) ahScore = 1; else if (d <= 4) ahScore = 2; else ahScore = 3;
        }

        // éœ²ç‚¹æ¸©åº¦ï¼š12-18 ç†æƒ³ï¼›10-12/18-20 è½»å¾®ï¼›8-10/20-22 ä¸­ç­‰ï¼›<8 æˆ– >22 ä¸¥é‡
        let tdScore = 0;
        if (Td < 12 || Td > 18) {
          let d = Td < 12 ? 12 - Td : Td - 18;
          if (d <= 2) tdScore = 1; else if (d <= 4) tdScore = 2; else tdScore = 3;
        }

        // VPDï¼š0.9-1.3 ç†æƒ³ï¼›0.8-0.9/1.3-1.6 è½»å¾®ï¼›<0.8 æˆ– >1.6 ä¸­ç­‰åé‡ï¼ˆ2 åˆ†ï¼‰ï¼›>2.0 ä¸¥é‡ï¼ˆ3 åˆ†ï¼‰
        let vpdScore = 0;
        if (VPD < 0.9 || VPD > 1.3) {
          if ((VPD >= 0.8 && VPD < 0.9) || (VPD > 1.3 && VPD <= 1.6)) vpdScore = 1;
          else if (VPD < 0.8 || (VPD > 1.6 && VPD <= 2.0)) vpdScore = 2;
          else if (VPD > 2.0) vpdScore = 3;
        }

        let total = tempScore + rhScore + ahScore + tdScore + vpdScore;

        // çŠ¶æ€ç­‰çº§
        let state, color, face;
        if (total <= 1) { state = 'èˆ’é€‚'; color = 'green'; face='ğŸ˜„'; }
        else if (total <= 3) { state = 'ç¨æœ‰ä¸é€‚'; color = 'goldenrod'; face='ğŸ™‚'; }
        else if (total <= 5) { state = 'éœ€è°ƒæ•´'; color = 'orange'; face='ğŸ˜“'; }
        else { state = AT >= 25 ? 'åçƒ­' : 'åå†·'; color = AT >= 25 ? 'red' : 'dodgerblue'; face = AT >= 25 ? 'ğŸ¥µ' : 'ğŸ¥¶'; }

        // ç¡çœ å»ºè®®ï¼ˆåŸºäº ATï¼‰
        let sleep;
        if (AT < 23) sleep = 'é•¿è¢–ï¼‹åšè–„æ¯¯';
        else if (AT < 24.5) sleep = 'é•¿è¢–ï¼‹è–„æ¯¯';
        else if (AT <= 26) sleep = 'è–„æ£‰é•¿è¢–/åŒ…å±è¡£';
        else if (AT <= 27.5) sleep = 'çŸ­è¢–ï¼‹è–„ç¡è¢‹';
        else sleep = 'çŸ­è¢–ï¼Œé£æ‰‡ä½æ¡£/åŠ å¼ºé€šé£';

        // ç”Ÿæˆç®€æ´å»ºè®®ï¼ˆæŒ‘ 2 æ¡æœ€ä¸»è¦é—®é¢˜ï¼‰
        let issues = [];
        if (tempScore>=1) issues.push(AT>25? 'æ¸©åº¦åé«˜ï¼Œé€‚å½“é™æ¸©' : 'æ¸©åº¦åä½ï¼Œé€‚å½“å¢æ¸©');
        if (rhScore>=1) issues.push(RH>60? 'æ¹¿åº¦åé«˜ï¼Œæ³¨æ„é™¤æ¹¿' : 'ç©ºæ°”åå¹²ï¼Œé€‚åº¦åŠ æ¹¿');
        if (vpdScore>=1) issues.push(VPD>1.3? 'VPDåå¤§ï¼Œä½“æ„Ÿæ›´å¹²' : 'VPDåå°ï¼Œä½“æ„Ÿå‘é—·');
        if (ahScore>=2) issues.push(AH>15? 'ç»å¯¹æ¹¿åº¦åé«˜' : 'ç»å¯¹æ¹¿åº¦åä½');
        if (tdScore>=2) issues.push(Td>18? 'éœ²ç‚¹é«˜ï¼Œé»è…»æ„Ÿå¼º' : 'éœ²ç‚¹ä½ï¼Œæ˜“å¹²ç‡¥');
        let tips = issues.slice(0,2).join('ï¼›');

        return {
          text: `${state} ${face}`,
          color,
          sleep: `ç¡è§‰: ${sleep}`,
          tips: tips ? `å»ºè®®ï¼š${tips}` : ''
        };
      }

      let s = scoreAndAdvice(AT_silent,RH,AH,Td,VPD);
      let a = scoreAndAdvice(AT_auto,RH,AH,Td,VPD);

      document.getElementById('resultSilent').innerText = `é™éŸ³: ${AT_silent.toFixed(1)}`;
      document.getElementById('comfortSilent').innerText = s.text; document.getElementById('comfortSilent').style.color = s.color;
      document.getElementById('sleepSilent').innerText = s.sleep;
      document.getElementById('tipsSilent').innerText = s.tips;

      document.getElementById('resultAuto').innerText = `è‡ªåŠ¨: ${AT_auto.toFixed(1)}`;
      document.getElementById('comfortAuto').innerText = a.text; document.getElementById('comfortAuto').style.color = a.color;
      document.getElementById('sleepAuto').innerText = a.sleep;
      document.getElementById('tipsAuto').innerText = a.tips;
    }
  </script>
</body>
</html>
